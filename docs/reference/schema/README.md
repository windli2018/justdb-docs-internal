---
icon: table
title: Schema 定义概述
order: 1
category:
  - 参考文档
  - Schema 定义
tag:
  - schema
  - reference
---

# Schema 定义概述

JustDB Schema 是一个用于描述数据库结构的声明式框架。通过 Schema 定义，你可以用一种数据库无关的方式描述表、列、索引、约束等数据库对象，然后由 JustDB 自动生成针对不同数据库的 DDL 语句。

## 核心概念

### Justdb（根节点）

`Justdb` 是 Schema 定义的根节点，包含所有的数据库对象定义：

```yaml
id: myapp
namespace: com.example
Table:
  - name: users
    Column:
      - name: id
        type: BIGINT
        primaryKey: true
```

### Schema 对象层次

```
Justdb (根节点)
├── Database       # 数据库定义
├── Table          # 表定义
├── Column         # 列定义（全局）
├── View           # 视图定义
├── Query          # 查询定义
├── Index          # 索引定义（全局）
├── Constraint     # 约束定义（全局）
├── Trigger        # 触发器定义
├── Sequence       # 序列定义
├── Procedure      # 存储过程定义
└── Data           # 数据导出定义
```

### Item（基础项）

所有 Schema 对象都继承自 `Item` 基类，提供以下通用属性：

| 属性 | 类型 | 说明 |
|------|------|------|
| `id` | String | 唯一标识符，用于引用 |
| `name` | String | 对象名称 |
| `referenceId` | String | 引用其他对象的 id |
| `formerNames` | List&lt;String&gt; | 曾用名列表，用于追踪重命名 |
| `comment` | String | 数据库注释（会写入数据库） |
| `remark` | String | JustDB 备注（不写入数据库） |
| `author` | String | 作者信息 |
| `version` | String | 版本信息 |
| `dbms` | List&lt;String&gt; | 适用数据库列表 |

## 核心特性

### 1. 数据库无关性

同一份 Schema 可生成多种数据库的 DDL：

```yaml
Table:
  - name: users
    Column:
      - name: id
        type: BIGINT
        primaryKey: true
        autoIncrement: true
```

生成结果：
- **MySQL**: `id BIGINT AUTO_INCREMENT PRIMARY KEY`
- **PostgreSQL**: `id BIGSERIAL PRIMARY KEY`
- **Oracle**: `id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY`

### 2. 组件复用（referenceId）

通过 `referenceId` 实现组件复用：

```yaml
# 全局列定义
Column:
  - id: global_id
    name: id
    type: BIGINT
    primaryKey: true
    autoIncrement: true

# 在表中引用
Table:
  - name: users
    Column:
      - id: col_users_id
        referenceId: global_id  # 引用全局定义
        name: id

  - name: orders
    Column:
      - id: col_orders_id
        referenceId: global_id  # 复用同一定义
        name: id
```

### 3. Schema 演进追踪（formerNames）

通过 `formerNames` 追踪对象重命名：

```yaml
Table:
  - name: users
    formerNames: [user]  # 记录曾用名
    Column:
      - name: user_name
        formerNames: [username]  # 列重命名
        type: VARCHAR(50)
```

生成的迁移 SQL：
```sql
ALTER TABLE user RENAME TO users;
ALTER TABLE users CHANGE COLUMN username user_name VARCHAR(50);
```

### 4. 生命周期钩子

在 DDL 操作前后执行自定义 SQL：

```yaml
Table:
  - name: users
    afterCreates:
      - dbms: postgresql
        content: CREATE INDEX CONCURRENTLY idx_users_username ON users(username);
      - dbms: mysql
        content: CREATE INDEX idx_users_username ON users(username);
```

### 5. 条件执行

基于数据库类型的条件执行：

```yaml
Table:
  - name: products
    afterCreates:
      - dbms: [postgresql, timescaledb]
        content: CREATE INDEX CONCURRENTLY idx_products_created_at ON products(created_at);
```

## Schema 对象详情

### Table（表）

表是数据库中最核心的对象，用于存储数据。详见 [表定义](./table.md)。

```yaml
Table:
  - id: table_users
    name: users
    comment: 用户表
    Column:
      - name: id
        type: BIGINT
        primaryKey: true
      - name: username
        type: VARCHAR(50)
        nullable: false
```

### Column（列）

列定义表的结构，包括数据类型、约束等。详见 [列定义](./column.md)。

```yaml
Column:
  - name: email
    type: VARCHAR(100)
    nullable: true
    defaultValue: null
    comment: 邮箱地址
```

### Index（索引）

索引用于提高查询性能。详见 [索引定义](./index-def.md)。

```yaml
Index:
  - id: idx_users_email
    name: idx_users_email
    tableName: users
    columns: [email]
    unique: true
```

### Constraint（约束）

约束用于保证数据完整性。详见 [约束定义](./constraint.md)。

```yaml
Constraint:
  - id: fk_orders_user_id
    name: fk_orders_user_id
    type: FOREIGN_KEY
    tableName: orders
    referencedTable: users
    referencedColumn: id
```

### View（视图）

视图是虚拟表，基于查询结果。详见 [视图定义](./view.md)。

```yaml
View:
  - name: active_users
    content: SELECT * FROM users WHERE status = 'active'
```

### Sequence（序列）

序列用于生成唯一数值。详见 [序列定义](./sequence.md)。

```yaml
Sequence:
  - name: seq_user_id
    startWith: 1
    incrementBy: 1
```

### Trigger（触发器）

触发器在特定事件发生时自动执行。详见 [触发器定义](./trigger.md)。

```yaml
Trigger:
  - name: trg_users_update_timestamp
    tableName: users
    event: UPDATE
    timing: BEFORE
    content: NEW.updated_at = CURRENT_TIMESTAMP
```

### Procedure（存储过程）

存储过程是预编译的 SQL 语句集合。详见 [存储过程定义](./procedure.md)。

```yaml
Procedure:
  - name: sp_create_user
    parameters:
      - name: p_username
        type: VARCHAR(50)
      - name: p_email
        type: VARCHAR(100)
    content: |
      INSERT INTO users (username, email) VALUES (p_username, p_email);
```

### 生命周期钩子

生命周期钩子允许在 DDL 操作前后执行自定义逻辑。详见 [生命周期钩子](./lifecycle-hooks.md)。

支持的钩子类型：
- `beforeCreates` / `afterCreates`
- `beforeDrops` / `afterDrops`
- `beforeAlters` / `afterAlters`
- `beforeAdds` / `afterAdds`

## 快速示例

### 完整的用户管理系统 Schema

```yaml
id: user-management
namespace: com.example

# 全局列定义
Column:
  - id: global_id
    name: id
    type: BIGINT
    primaryKey: true
    autoIncrement: true

  - id: global_created_at
    name: created_at
    type: TIMESTAMP
    nullable: false
    defaultValueComputed: CURRENT_TIMESTAMP

  - id: global_updated_at
    name: updated_at
    type: TIMESTAMP
    nullable: false
    defaultValueComputed: CURRENT_TIMESTAMP

# 用户表
Table:
  - id: table_users
    name: users
    comment: 用户表
    Column:
      - id: col_users_id
        referenceId: global_id
        name: id

      - name: username
        type: VARCHAR(50)
        nullable: false
        comment: 用户名

      - name: email
        type: VARCHAR(100)
        comment: 邮箱

      - id: col_users_created_at
        referenceId: global_created_at
        name: created_at

      - id: col_users_updated_at
        referenceId: global_updated_at
        name: updated_at

    Index:
      - name: idx_users_username
        columns: [username]
        unique: true

      - name: idx_users_email
        columns: [email]
        unique: true

# 订单表
  - id: table_orders
    name: orders
    comment: 订单表
    Column:
      - id: col_orders_id
        referenceId: global_id
        name: id

      - name: user_id
        type: BIGINT
        nullable: false
        comment: 用户ID

      - name: total_amount
        type: DECIMAL(10,2)
        defaultValue: 0.00
        comment: 订单金额

      - id: col_orders_created_at
        referenceId: global_created_at
        name: created_at

    Constraint:
      - id: fk_orders_user_id
        name: fk_orders_user_id
        type: FOREIGN_KEY
        referencedTable: users
        referencedColumn: id
        columns: [user_id]

# 活跃用户视图
View:
  - name: active_users
    comment: 活跃用户视图
    content: |
      SELECT *
      FROM users
      WHERE last_login_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
```

## 相关文档

- [表定义](./table.md)
- [列定义](./column.md)
- [索引定义](./index-def.md)
- [约束定义](./constraint.md)
- [视图定义](./view.md)
- [序列定义](./sequence.md)
- [触发器定义](./trigger.md)
- [存储过程定义](./procedure.md)
- [生命周期钩子](./lifecycle-hooks.md)
- [格式支持](../formats/)
