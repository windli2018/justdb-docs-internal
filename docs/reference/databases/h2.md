# H2 数据库支持

JustDB 提供完整的 H2 数据库支持，包括嵌入式模式和服务器模式。

## 版本支持

| 版本 | 状态 | 说明 |
|------|------|------|
| H2 2.x | 完全支持 | 最新稳定版 |
| H2 1.4.x | 完全支持 | 稳定版本 |

## 连接配置

### JDBC 驱动

```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <version>2.1.210</version>
</dependency>
```

### 连接字符串

#### 嵌入式模式 (Embedded)

```bash
# 基本格式
jdbc:h2:{file}

# 示例
jdbc:h2:~/test
jdbc:h2:/data/sample
jdbc:h2:./mydb
```

#### 服务器模式 (Server)

```bash
# 基本格式
jdbc:h2:tcp://{host}[:{port}]/[{database}]

# 示例
jdbc:h2:tcp://localhost:9092/~/test
jdbc:h2:tcp://192.168.1.100:9092/data/sample
```

#### 内存模式 (In-Memory)

```bash
# 基本格式
jdbc:h2:mem:{database}

# 示例
jdbc:h2:mem:test
jdbc:h2:mem:test_db;DB_CLOSE_DELAY=-1
```

### 配置示例

**YAML:**
```yaml
databases:
  production:
    url: jdbc:h2:tcp://localhost:9092/~/test
    driver: org.h2.Driver
    username: sa
    password: ""
    dialect: h2
```

**JSON:**
```json
{
  "databases": {
    "production": {
      "url": "jdbc:h2:tcp://localhost:9092/~/test",
      "driver": "org.h2.Driver",
      "username": "sa",
      "password": "",
      "dialect": "h2"
    }
  }
}
```

**XML:**
```xml
<databases>
  <database id="production">
    <url>jdbc:h2:tcp://localhost:9092/~/test</url>
    <driver>org.h2.Driver</driver>
    <username>sa</username>
    <password></password>
    <dialect>h2</dialect>
  </database>
</databases>
```

## 数据类型映射

### 数值类型

| JustDB 类型 | H2 类型 | JDBC 类型 | Java 类型 | 说明 |
|-------------|---------|-----------|-----------|------|
| TINYINT | TINYINT | TINYINT | Integer | 1 字节整数 |
| SMALLINT | SMALLINT | SMALLINT | Integer | 2 字节整数 |
| INTEGER | INT | INTEGER | Integer | 4 字节整数 |
| BIGINT | BIGINT | BIGINT | Long | 8 字节整数 |
| DECIMAL | DECIMAL(p,s) | DECIMAL | BigDecimal | 精确数值 |
| NUMERIC | NUMERIC(p,s) | NUMERIC | BigDecimal | 精确数值 |
| FLOAT | REAL | FLOAT | Float | 单精度浮点 |
| DOUBLE | DOUBLE | DOUBLE | Double | 双精度浮点 |

### 字符串类型

| JustDB 类型 | H2 类型 | JDBC 类型 | Java 类型 | 说明 |
|-------------|---------|-----------|-----------|------|
| CHAR | CHAR(n) | CHAR | String | 固定长度字符串 |
| VARCHAR | VARCHAR(n) | VARCHAR | String | 可变长度字符串 |
| CLOB | CLOB | CLOB | String | 大文本 |
| VARCHAR_IGNORECASE | VARCHAR_IGNORECASE | VARCHAR | String | 不区分大小写 |

### 日期时间类型

| JustDB 类型 | H2 类型 | JDBC 类型 | Java 类型 | 说明 |
|-------------|---------|-----------|-----------|------|
| DATE | DATE | DATE | Date | 日期 |
| TIME | TIME(n) | TIME | Time | 时间 |
| TIMESTAMP | TIMESTAMP(n) | TIMESTAMP | Timestamp | 时间戳 |
| TIMESTAMP_WITH_TIMEZONE | TIMESTAMP WITH TIME ZONE | TIMESTAMP_WITH_TIMEZONE | Timestamp | 时间戳带时区 |

### 二进制类型

| JustDB 类型 | H2 类型 | JDBC 类型 | Java 类型 | 说明 |
|-------------|---------|-----------|-----------|------|
| BINARY | BINARY(n) | BINARY | byte[] | 固定长度二进制 |
| VARBINARY | VARBINARY(n) | VARBINARY | byte[] | 可变长度二进制 |
| BLOB | BLOB | BLOB | byte[] | 二进制大对象 |

### 其他类型

| JustDB 类型 | H2 类型 | JDBC 类型 | Java 类型 | 说明 |
|-------------|---------|-----------|-----------|------|
| BOOLEAN | BOOLEAN | BOOLEAN | Boolean | 布尔值 |
| UUID | UUID | UUID | String/UUID | UUID 标识符 |
| ARRAY | ARRAY | ARRAY | Array | 数组类型 |
| GEOMETRY | GEOMETRY | GEOMETRY | byte[] | 几何类型 |
| JSON | JSON | JSON | String | JSON 数据 (H2 2.x+) |
| ENUM | ENUM | VARCHAR | String | 枚举类型 |

## H2 特定功能

### AUTO_INCREMENT

```yaml
tables:
  - name: users
    columns:
      - name: id
        type: BIGINT
        primaryKey: true
        autoIncrement: true
```

### 内存表选项

```yaml
tables:
  - name: cache
    engine: MEMORY  # 内存表
    columns:
      - name: key
        type: VARCHAR(255)
        primaryKey: true
```

### 临时表

```yaml
tables:
  - name: temp_data
    temporary: true
    columns:
      - name: data
        type: TEXT
```

### 列默认值

```yaml
tables:
  - name: users
    columns:
      - name: created_at
        type: TIMESTAMP
        defaultValueComputed: "CURRENT_TIMESTAMP"
```

## 生成的 SQL 示例

### CREATE TABLE

```sql
CREATE TABLE IF NOT EXISTS users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ALTER TABLE

```sql
-- 添加列
ALTER TABLE users ADD COLUMN status VARCHAR(50) DEFAULT 'active' NOT NULL;

-- 修改列类型
ALTER TABLE users ALTER COLUMN email VARCHAR(500);

-- 修改列约束
ALTER TABLE users ALTER COLUMN email SET NOT NULL;

-- 重命名列
ALTER TABLE users RENAME COLUMN username TO login_name;

-- 删除列
ALTER TABLE users DROP COLUMN status;
```

### CREATE INDEX

```sql
CREATE INDEX IF NOT EXISTS idx_username ON users (username);
CREATE UNIQUE INDEX IF NOT EXISTS idx_email ON users (email);
```

### DROP TABLE

```sql
DROP TABLE IF EXISTS users;
```

## 已知限制

### 与其他数据库的差异

1. **存储过程**: H2 的存储过程语法与 MySQL/Oracle 有差异
2. **触发器**: H2 的触发器使用 Java 编写
3. **全文索引**: H2 的全文索引实现方式不同
4. **视图**: H2 的视图功能相对简单

### 数据类型限制

1. **ENUM**: H2 2.x 支持 ENUM，但语法有差异
2. **JSON**: H2 2.x+ 支持 JSON，但功能相对简单
3. **GEOMETRY**: 空间类型支持有限

## 最佳实践

### 1. 使用内存数据库进行测试

```yaml
databases:
  test:
    url: jdbc:h2:mem:test_db;DB_CLOSE_DELAY=-1
    driver: org.h2.Driver
    username: sa
    password: ""
    dialect: h2
```

### 2. 使用 AUTO_INCREMENT

```yaml
tables:
  - name: users
    columns:
      - name: id
        type: BIGINT
        primaryKey: true
        autoIncrement: true
```

### 3. 利用 IF EXISTS/IF NOT EXISTS

```yaml
# H2 完全支持 IF EXISTS 和 IF NOT EXISTS
tables:
  - name: users
    idempotent: true
```

### 4. 使用 CLOB 存储大文本

```yaml
tables:
  - name: posts
    columns:
      - name: content
        type: CLOB
```

### 5. 使用内存表提升性能

```yaml
tables:
  - name: cache
    engine: MEMORY  # 内存表，访问更快
```

## 使用场景

### 1. 开发和测试

H2 是开发和测试环境的理想选择：

```yaml
databases:
  development:
    url: jdbc:h2:./dev_db
    dialect: h2
```

### 2. 单元测试

使用内存数据库加速测试：

```yaml
databases:
  test:
    url: jdbc:h2:mem:test;DB_CLOSE_DELAY=-1;MODE=MySQL
    dialect: h2
```

### 3. 嵌入式应用

直接嵌入到应用程序中：

```yaml
databases:
  embedded:
    url: jdbc:h2:./data/app_db
    dialect: h2
```

### 4. 服务器模式

多客户端连接：

```yaml
databases:
  server:
    url: jdbc:h2:tcp://localhost:9092/~/production
    dialect: h2
```

## 兼容模式

H2 可以模拟其他数据库的语法：

```bash
# MySQL 兼容模式
jdbc:h2:mem:test;MODE=MySQL

# PostgreSQL 兼容模式
jdbc:h2:mem:test;MODE=PostgreSQL

# Oracle 兼容模式
jdbc:h2:mem:test;MODE=Oracle

# SQL Server 兼容模式
jdbc:h2:mem:test;MODE=MSSQLServer
```

## 性能优化

### 1. 连接池配置

```yaml
databases:
  production:
    url: jdbc:h2:tcp://localhost:9092/~/test;CACHE_SIZE=65536
    dialect: h2
    pool:
      maxSize: 10
      minIdle: 2
```

### 2. 页大小调整

```bash
jdbc:h2:./test;PAGE_SIZE=16384
```

### 3. 压缩选项

```bash
jdbc:h2:./test;COMPRESS=TRUE
```

## 相关文档

- [H2 官方文档](https://www.h2database.com/html/main.html)
- [H2 数据类型参考](https://www.h2database.com/html/datatypes.html)
- [数据库支持概述](./README.md)
